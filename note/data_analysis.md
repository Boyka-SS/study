

[物联网数据传输协议MQTT介绍与应用开发详解-华为开发者论坛 | 华为开发者联盟 (huawei.com)](https://developer.huawei.com/consumer/cn/forum/topic/0202605205735200040?fid=23)



**1、下载mosquitto，通过mosquitto订阅老师网址的数据**

下载好后，记住安装位置

下载链接：

[Download | Eclipse Mosquitto](https://mosquitto.org/download/)

![输入图片说明](https://foruda.gitee.com/images/1677683459560248701/c7b06f11_8027319.png "QQ截图20230301185337.png")

**2、找到安装目录**

![输入图片说明](https://foruda.gitee.com/images/1677683494818529213/9a466955_8027319.png "QQ截图20230301185546.png")

`win+r` 输入cmd，打开命令窗口，cd 命令切换到安装位置的目录下

输入如下命令，然后等待订阅数据的返回：

`mosquitto_sub.exe -h 111.229.163.181 -p 1883 -t application/1/device/+/rx`

【参数解释】

- -h

  主机名，这里为111.229.163.181

- -p

  主机端口号，1883

- -t

  订阅的主题

  `application/1/device/+/rx`

  这里使用了+通配符，上述使用了通配符的主题可以匹配如下主题

  - application/1/device/8D00003100000005/rx
  - application/1/device/8D00003100000006/rx
  - application/1/device/8D00003100000007/rx
  - application/1/device/8D00003100000008/rx

【问题描述】

在本人window平台上输入上述订阅命令，出现了如下问题：

![输入图片说明](https://foruda.gitee.com/images/1677683513592913002/8922fd47_8027319.png "QQ截图20230301185740.png")

本人没有解决掉，可以通过虚拟机搭建Linux，通过命令行的方式获取到数据。虽然window上命令行没有数据，但是编程实现时却可以获取到数据。



**3、解析数据**

![输入图片说明](https://foruda.gitee.com/images/1677683585437111616/48df6c4d_8027319.png "QQ截图20230301192144.png")

上图为订阅命令的返回结果

```json
{
  "applicationID": "1",
  "applicationName": "smart21",
  "deviceName": "kuntai-06",
  "devEUI": "8d00003100000006",
  "rxInfo": [
    {
      "gatewayID": "8e00000200000001",
      "uplinkID": "4d0f6ad7-9379-4ff0-a03f-3d847b766f81",
      "name": "8e00000200000001",
      "rssi": -50,
      "loRaSNR": 8.8,
      "location": {
        "latitude": 32.11833,
        "longitude": 118.87167,
        "altitude": 198
      }
    }
  ],
  "txInfo": { "frequency": 486900000, "dr": 5 },
  "adr": true,
  "fCnt": 5,
  "fPort": 88,
  "data": "/hwCAwMEALICUwQEAACMPAICA0oBBACqApaX/g=="
}
```

本篇只关注毕设所需要的参数  `data`字段（`devEUI`为设备id）。

这里的data字段 <u>*`需要base64解码后`*</u> 才可以看到真正数据。

复制data字段的值到  https://the-x.cn/base64/  进行解码

![输入图片说明](https://foruda.gitee.com/images/1677683609404771971/9bc2cb99_8027319.png "QQ截图20230301193502.png")

根据老师发的文档 **《AQ20-I通讯协议20200720-V1.1.docx》** 分析数据

![输入图片说明](https://foruda.gitee.com/images/1677683622457272642/5ee0aa81_8027319.png "QQ截图20230301193739.png")

**【重点】** 

```
FE 1C 02 03 03 04 00 B2  02 53 04 04 00 00 8C 3C 02 02 03 4A 01 04 00 AA  02 96 97 FE  
```

如上是base64解码的结果，`数据为16进制，利用计算器转为10进制`。看上表，知

1. 字符串`fe`为数据起始-终止点

2. 序号为1的length字节，表示`整个订阅数据的总字节数（理解成数据长度即可）`，这里为1c，转10进制为28，说明消息长度为28bytes

3. 序号2，3，m+4，m+5暂时先不用过多关注（整个消息的前4个和最后两个不用过多关注，有效数据从第5个字节开始）

4. 理解数据区前，先明白：`一个终端带有多个传感器，可以将多项数据一起同时上传，具体请看《终端上报数据data字段说明.xlsx 》或者01,02视频`

   ![输入图片说明](https://foruda.gitee.com/images/1677683642684865449/3dafb516_8027319.png "QQ截图20230301195517.png")

   > 上图解释：终端276，带有三个传感器，根据addr(485地址)确定数据类型。

   数据区m：

   一个数据区由多个数据项组成，一个数据项由`485地址`，`有效数据长度`，`有效数据`三个有序组成

   经过处理后，数据如下：

   ```
   03 04 00 B2 02 53 04 04 00 00 8C 3C 02 02 03 4A 01 04 00 AA 02 96
   ```

   首先这是终端`8d00003100000006`（devEUI）的数据，查excel知道

   ![输入图片说明](https://foruda.gitee.com/images/1677683655856321105/bcaace1d_8027319.png "QQ截图20230301200038.png")

   数据项`03 04 00 B2 02 53`解释

   485地址为3表示数据项含义为水温和浊度，各占两个字节（水温在前，浊度在后）。

   04表示后面四个字节为有效数据。

   00 B2表示水温，这里为16进制，转10进制后为178，然后除以10，得17.8，即水温为17.8℃

   > 【切记】16进制数据 -> 10进制数据 -> 结果除以10 -> 最终数据

   02 53表示浊度，转10进制为595，除以10得59.5，即浊度为59.5%

   结束后进入下一个数据项`04 04 00 00 8C 3C`->`02 02 03 4A `->`01 04 00 AA 02 96`

   > 如何确定数据项？
   > 首先一个数据项固定有两个字节，第一个字节为485地址，表示数据类型，第二个字节存放数据长度。然后长度后紧跟有效数据，有效数据占用的字节数，由第二个字节决定。

这里仅仅介绍了数值怎么计算，具体编码可能需要更多地思考

数据类型计算：
- 水温 （温度同）
00AF H(十六进制)=175=>水温=17.5℃
- 湿度
292 H(十六进制)=658=>湿度=65.8%RH
- PH 
00BD H(十六进制)=189=>PH=1.89PH
- 电导率
0028 H(十六进制)=40=>电导率=0.4 us/cm
- 光照辐射强度
0047H(十六进制)=71=>光合有效辐射=71 w/ m2
- 光照度
000206F6H(十六进制)=132854=>光照度=132854Lux
- 电导率
00BD H(十六进制)=189=>电导率=1.89 us/cm
- 浊度
00BD H(十六进制)=189=>浊度=189NTU
- 溶解氧
00BD H(十六进制)=189=>溶解氧=1.89mg/L

